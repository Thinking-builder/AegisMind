# 恶意程序检测系统 - 功能需求文档

## 1. 项目概述

### 1.1 项目名称
恶意程序检测系统（Web端应用）

### 1.2 项目定位
基于威胁情报的恶意程序检测与分析平台，通过多维度检测技术识别恶意程序，并生成专业的威胁分析报告。

### 1.3 核心功能
系统能够自动判断上传的文件是否为恶意程序，支持单样本检测和批量样本检测两种模式：
- **单样本检测模式**：对单个文件进行深度分析，生成基于威胁情报的详细分析报告
- **批量样本检测模式**：对多个文件进行批量检测，输出检测结果统计和性能评估

---

## 2. 功能需求

### 2.0 首页欢迎页面与模式选择

**功能描述：**
- 系统首页提供欢迎界面
- 用户可选择检测模式：
  - **单样本检测**：进入单样本深度分析流程
  - **批量样本检测**：进入批量检测流程

**界面交互：**
- 首页显示两个主要入口按钮："单样本检测"和"批量样本检测"
- 点击后进入对应的检测界面
- 支持在检测过程中返回首页切换模式

---

## 2.1 单样本检测模式

#### 2.1.1 文件上传功能

**功能描述：**
- 用户可通过Web界面上传待检测文件
- 支持的文件类型：PE文件、EVTX文件、脚本等，先不做限制，

**技术要求：**
- 支持文件拖拽上传
- 文件类型自动识别

---

#### 2.1.2 检测模块动态激活

**功能描述：**
根据上传文件的类型，系统自动激活相应的检测模块：

| 文件类型 | 激活模块 |
|---------|---------|
| 非evtx文件 | 静态检测模块、人工智能检测模块 |
| EVTX文件 | 动态检测模块 |

**界面交互：**
- 未上传文件时，所有检测模块按钮为禁用状态（灰色）
- 上传非EVTX文件后，"静态检测"和"人工智能检测"按钮变为可用状态（高亮）
- 上传EVTX文件后，"动态检测"按钮变为可用状态（高亮）
- 可同时上传多种类型文件，对应模块同时激活

---

#### 2.1.3 LLM联网选项

**功能描述：**
- 提供"Internet"选项按钮
- 用户可选择是否允许LLM在生成报告时联网获取信息
- 点击后按钮状态切换（高亮/普通）

**使用场景：**
- 启用后，调用LLM API时将设置联网参数，允许大模型访问互联网获取最新威胁情报和相关信息
- 禁用时，LLM仅基于提供的检测结果进行分析，不进行联网查询
- 该选项作为LLM API调用时的参数传递，控制大模型的联网能力

---

#### 2.1.4 分析流程控制

**功能描述：**
- 提供"开始分析"按钮
- 点击后，系统根据已激活的模块和用户选择，启动相应的检测流程
- 分析过程中显示进度状态（侧面）

**执行逻辑：**
1. 检查已激活的检测模块
2. 检查是否启用Internet选项（用于后续LLM API调用）
3. 按模块串行执行检测任务
4. 收集所有检测结果
5. 将Internet选项状态传递给LLM API调用

---

#### 2.1.5 检测模块详细说明

#### 2.5.1 静态检测模块

**适用文件类型：** PE文件

**检测方法：** YARA规则匹配

**功能描述：**
- 对PE文件进行静态特征分析
- 使用YARA规则引擎进行恶意代码特征匹配
- 输出匹配结果和规则命中信息

**接口要求：**
- 预留API接口，支持后续集成YARA引擎
- 接口输入：文件数据
- 接口输出：YARA匹配结果（JSON格式）

---

#### 2.5.2 人工智能检测模块

**适用文件类型：** 非evtx文件

**检测方法：** 机器学习模型分析

**功能描述：**
- 使用训练好的AI模型对文件进行智能分析
- 识别恶意行为模式和异常特征
- 输出模型分析结果

**接口要求：**
- 预留API接口，支持后续集成AI模型服务
- 接口输入：文件数据
- 接口输出：模型分析结果（JSON格式，包含分类结果等）

---

#### 2.5.3 动态检测模块

**适用文件类型：** EVTX文件（Windows事件日志）

**检测方法：** Sigma规则匹配

**功能描述：**
- 分析Windows事件日志文件（EVTX）
- 使用Sigma规则进行威胁行为检测
- 识别异常系统行为和攻击痕迹

**接口要求：**
- 预留API接口，支持后续集成Sigma规则引擎
- 接口输入：EVTX文件数据
- 接口输出：Sigma匹配结果（JSON格式）

---

#### 2.1.6 结果整合与报告生成

#### 2.6.1 结果整合

**功能描述：**
- 收集所有已执行检测模块的输出结果
- 整合静态检测、AI检测、动态检测的结果
- 记录Internet选项状态，用于后续LLM API调用

**数据格式：**
- 统一的结果数据结构（JSON格式）
- 包含：检测模块名称、检测结果等

---

#### 2.6.2 提示词构建

**功能描述：**
根据整合的检测结果，构建发送给大语言模型的提示词。

**提示词内容结构：**
```
基于以下检测信息，请生成一份专业的恶意程序分析报告：

【静态检测结果】
[YARA匹配结果详情]

【人工智能检测结果】
[模型分析结果详情]

【动态检测结果】
[Sigma匹配结果详情]

请基于以上信息，输出一份Markdown格式的病毒分析报告，报告应包含：
1. 样本基本信息
2. 威胁等级评估
3. 检测结果汇总
4. 行为分析
5. 威胁情报关联（如启用Internet选项，可联网查询最新威胁情报）
6. 防护建议
```

---

#### 2.6.3 LLM报告生成

**功能描述：**
- 通过API连接大语言模型服务
- 将构建的提示词发送至LLM
- 根据用户选择的Internet选项，设置LLM API的联网参数
- 接收LLM返回的分析报告

**技术要求：**
- 支持主流大模型API（OpenAI、Claude、国产大模型等）
- API调用时根据Internet选项设置联网参数（如：`enable_internet: true/false`）
- 启用Internet时，LLM可联网查询最新威胁情报、CVE信息等
- 禁用Internet时，LLM仅基于提供的检测结果进行分析
- API调用异常处理和重试机制
- 响应超时控制

**输出格式：**
- Markdown格式的文本报告
- 包含完整的恶意程序分析内容
- 启用Internet时，报告可能包含联网查询到的最新威胁情报信息

---

#### 2.1.7 报告展示与下载

**功能描述：**
- 在Web界面展示生成的Markdown格式报告
- 提供报告预览功能（支持Markdown渲染）
- 提供"下载报告"按钮

**下载功能：**
- 支持下载为Markdown文件（.md）
- 可选：支持导出为PDF格式（后续扩展）

---

## 2.2 批量样本检测模式

### 2.2.1 批量文件上传功能

**功能描述：**
- 用户可通过Web界面上传多个待检测文件
- 支持的文件类型：PE文件、EVTX文件、脚本等，先不做限制
- 支持批量文件选择或文件夹上传

**技术要求：**
- 支持文件拖拽上传（可多选）
- 文件类型自动识别
- 显示已上传文件列表和数量
- 支持删除已选文件

---

### 2.2.2 检测模块动态激活（批量模式）

**功能描述：**
根据上传文件的类型，系统自动激活相应的检测模块：

| 文件类型 | 激活模块 |
|---------|---------|
| 非evtx文件 | 静态检测模块、人工智能检测模块 |
| EVTX文件 | 动态检测模块 |

**界面交互：**
- 未上传文件时，所有检测模块按钮为禁用状态（灰色）
- 上传非EVTX文件后，"静态检测"和"人工智能检测"按钮变为可用状态（高亮）
- 上传EVTX文件后，"动态检测"按钮变为可用状态（高亮）
- 可同时上传多种类型文件，对应模块同时激活

**注意：** 批量检测模式不提供Internet联网选项和LLM报告生成功能

---

### 2.2.3 Ground Truth上传（可选）

**功能描述：**
- 提供"是否上传Ground Truth"选项
- 用户可选择上传标准答案文件用于性能评估

**Ground Truth文件格式：**
- 文件格式：CSV或JSON
- 数据内容：
  - 文件名（与上传的检测文件对应）
  - 是否为恶意（0表示良性，1表示恶意）
- 示例格式（CSV）：
  ```
  文件名,是否为恶意
  sample1.exe,1
  sample2.exe,0
  sample3.dll,1
  ```

**使用场景：**
- 上传Ground Truth后，系统将计算检测准确率、漏报率、错报率等性能指标
- 输出检测错误的文件名列表（漏报和错报）

---

### 2.2.4 批量分析流程控制

**功能描述：**
- 提供"开始批量分析"按钮
- 点击后，系统对每个文件执行相应的检测流程
- 分析过程中显示总体进度和当前处理文件

**执行逻辑：**
1. 检查已激活的检测模块
2. 检查是否上传Ground Truth
3. 对每个文件按模块串行执行检测任务
4. 收集所有文件的检测结果
5. 如上传了Ground Truth，进行结果对比和性能评估
6. 整合所有结果并生成批量检测报告

---

### 2.2.5 批量检测结果输出

**功能描述：**
批量检测完成后，系统输出以下内容：

**基础输出（必选）：**
- 文件名列表
- 每个文件的检测结果（拼接后的检测结果）
- 检测结果格式：JSON，包含各模块的检测结果

**性能评估输出（仅在上传Ground Truth时）：**
- 漏报率（False Negative Rate）
- 错报率（False Positive Rate）
- 准确率（Accuracy）
- 精确率（Precision）
- 召回率（Recall）
- 检测错误的文件名列表：
  - 漏报文件（实际为恶意但检测为良性）
  - 错报文件（实际为良性但检测为恶意）

**输出格式：**
- 支持在线查看（表格形式）
- 支持下载为CSV或JSON文件
- 支持导出为Excel格式（后续扩展）

---

### 2.2.6 批量检测结果展示

**功能描述：**
- 在Web界面以表格形式展示批量检测结果
- 表格列包含：文件名、文件类型、检测结果、各模块结果、是否为恶意（如上传Ground Truth）
- 支持结果筛选和排序
- 如上传Ground Truth，错误检测的文件高亮显示

**下载功能：**
- 支持下载为CSV文件
- 支持下载为JSON文件
- 可选：支持导出为Excel格式（后续扩展）

---

## 3. 技术架构要求

### 3.1 接口预留

以下模块需预留标准化接口，便于后续集成：

1. **静态检测接口**
   - 接口路径：`/api/detection/static`
   - 请求方法：POST
   - 请求参数：文件数据
   - 响应格式：JSON

2. **人工智能检测接口**
   - 接口路径：`/api/detection/ai`
   - 请求方法：POST
   - 请求参数：文件数据
   - 响应格式：JSON

3. **动态检测接口**
   - 接口路径：`/api/detection/dynamic`
   - 请求方法：POST
   - 请求参数：文件数据
   - 响应格式：JSON

4. **LLM API接口**（仅单样本检测模式）
   - 接口路径：`/api/llm/generate-report`
   - 请求方法：POST
   - 请求参数：提示词内容、Internet选项（布尔值，控制LLM是否联网）
   - 响应格式：JSON（包含报告文本）

5. **批量检测接口**
   - 接口路径：`/api/detection/batch`
   - 请求方法：POST
   - 请求参数：文件列表（多文件）、检测模块选择、Ground Truth数据（可选）
   - 响应格式：JSON（包含每个文件的检测结果）

6. **性能评估接口**（批量检测模式，需Ground Truth）
   - 接口路径：`/api/evaluation/performance`
   - 请求方法：POST
   - 请求参数：检测结果列表、Ground Truth数据
   - 响应格式：JSON（包含准确率、漏报率、错报率、错误文件列表等）

---

### 3.2 数据流设计

#### 3.2.1 单样本检测模式数据流

```
首页 → 选择"单样本检测"
    ↓
文件上传 → 文件类型识别 → 模块激活
    ↓
用户选择LLM联网选项（Internet）
    ↓
点击"开始分析"
    ↓
串行执行检测模块
    ↓
结果整合 → 构建提示词
    ↓
调用LLM API → 生成报告
    ↓
展示报告 → 提供下载
```

#### 3.2.2 批量样本检测模式数据流

```
首页 → 选择"批量样本检测"
    ↓
批量文件上传 → 文件类型识别 → 模块激活
    ↓
（可选）上传Ground Truth
    ↓
点击"开始批量分析"
    ↓
对每个文件串行执行检测模块
    ↓
收集所有文件检测结果
    ↓
（如上传Ground Truth）性能评估计算
    ↓
整合结果 → 生成批量检测报告
    ↓
展示结果表格 → 提供下载
```

---

## 4. 非功能性需求

### 4.1 性能要求
- 文件上传响应时间 < 2秒
- 检测模块执行时间：根据文件大小和复杂度，合理控制
- LLM API调用超时时间：建议30-60秒

### 4.2 安全要求
- 文件上传需进行安全校验
- 检测结果数据加密存储（如需要）
- API接口需进行身份认证（后续实现）

### 4.3 用户体验要求
- 界面简洁直观，操作流程清晰
- 提供实时进度反馈
- 错误信息提示友好明确

---

## 5. 后续开发计划

### 5.1 第一阶段：前端界面设计
- 首页欢迎页面和模式选择界面
- 单样本检测界面布局设计
- 批量样本检测界面布局设计
- 文件上传组件开发（支持单文件和批量）
- 模块激活状态管理
- 报告展示组件
- Ground Truth上传组件

### 5.2 第二阶段：后端服务开发
- 文件处理服务（单文件和批量）
- 检测模块接口封装
- LLM API集成（单样本模式）
- 结果整合逻辑
- 批量检测结果处理
- 性能评估计算模块（批量模式）

### 5.3 第三阶段：检测引擎集成
- YARA引擎集成
- AI模型服务集成
- Sigma规则引擎集成
- 威胁情报API集成

---

## 6. 术语表

| 术语 | 说明 |
|-----|------|
| PE文件 | Portable Executable，Windows可执行文件格式 |
| EVTX文件 | Windows事件日志文件格式 |
| YARA | 恶意代码检测规则引擎 |
| Sigma | 威胁检测规则格式，用于日志分析 |
| LLM | Large Language Model，大语言模型 |
| 威胁情报 | Threat Intelligence，关于网络威胁的信息 |
| Ground Truth | 标准答案，用于评估检测系统性能的真实标签数据 |
| 漏报率 | False Negative Rate，实际为恶意但被检测为良性的比例 |
| 错报率 | False Positive Rate，实际为良性但被检测为恶意的比例 |

---

## 7. 附录

### 7.1 参考文档
- YARA规则文档
- Sigma规则规范
- 威胁情报标准（STIX/TAXII）

### 7.2 版本历史
- v1.0 - 初始版本（当前文档）
