<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>单样本检测 - 恶意文件检测平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: {
                            dark: '#0f172a',
                            glass: 'rgba(255, 255, 255, 0.05)',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; position: relative; }
        #matrixCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.3; mix-blend-mode: screen; }
        .glass-panel { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.3em; margin-top: 1.2em; color: #38bdf8; }
        .markdown-body p { margin-bottom: 1em; line-height: 1.6; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body code { background: rgba(255,255,255,0.1); padding: 0.2em 0.4em; border-radius: 3px; color: #f472b6; font-family: monospace; }
        .markdown-body pre { background: #1e293b; padding: 1em; border-radius: 8px; overflow-x: auto; margin-bottom: 1em; }
        .module-card { transition: all 0.2s ease-in-out; }
    </style>
</head>
<body class="min-h-screen flex flex-col relative">

    <canvas id="matrixCanvas"></canvas>

    <nav class="glass-panel sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <a href="index.html" class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500 hover:opacity-80 transition">
                <i class="fa-solid fa-shield-halved mr-2"></i>MDS
            </a>
            <span class="px-3 py-1 rounded-full bg-cyan-500/10 text-cyan-400 text-xs border border-cyan-500/20">单样本模式</span>
        </div>
        <a href="index.html" class="text-gray-400 hover:text-white transition">
            <i class="fa-solid fa-house mr-1"></i> 返回首页
        </a>
    </nav>

    <main class="flex-1 p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 max-w-[1600px] mx-auto w-full relative z-10">
        <div class="lg:col-span-4 space-y-6">
            <div class="glass-panel rounded-2xl p-6 relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-1 h-full bg-cyan-500"></div>
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-cloud-arrow-up text-cyan-400"></i> 上传样本
                </h3>
                
                <div id="dropZone" class="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center transition-all duration-300 hover:border-cyan-500 hover:bg-cyan-500/5 cursor-pointer relative">
                    <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    <div id="uploadPlaceholder">
                        <i class="fa-solid fa-file-shield text-4xl text-gray-500 mb-3 group-hover:scale-110 transition-transform"></i>
                        <p class="text-gray-300 font-medium">拖拽文件到此处或点击选择</p>
                        <p class="text-gray-500 text-xs mt-1">支持 PE (.exe/.dll) 与 EVTX</p>
                    </div>
                    <div id="fileInfo" class="hidden">
                        <i class="fa-solid fa-file-code text-4xl text-cyan-400 mb-3"></i>
                        <p id="fileName" class="text-white font-medium truncate"></p>
                        <p id="fileSize" class="text-gray-500 text-xs"></p>
                        <p id="fileType" class="text-gray-400 text-xs mt-1"></p>
                        <button id="removeBtn" class="mt-3 text-xs text-red-400 hover:text-red-300 underline">移除文件</button>
                    </div>
                </div>
                <p id="uploadError" class="text-sm text-red-400 mt-3 hidden"></p>
            </div>

            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4">检测模块配置</h3>
                <p class="text-xs text-gray-500 mb-3">根据文件类型自动启用可用模块，你也可以手动勾选。</p>
                
                <div class="space-y-3">
                    <div id="moduleStatic" data-enabled="false" data-selected="false" class="module-card flex items-center justify-between p-3 rounded-lg bg-gray-800/50 border border-gray-700 opacity-30 cursor-not-allowed">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded bg-gray-700 flex items-center justify-center icon-bg transition-colors">
                                <i class="fa-solid fa-code text-gray-400 icon transition-colors"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-sm text-gray-300 module-title">静态检测</h4>
                                <p class="text-xs text-gray-500">YARA 规则匹配</p>
                            </div>
                        </div>
                        <i class="fa-regular fa-circle text-gray-600 status-icon text-lg transition-transform duration-300"></i>
                    </div>

                    <div id="moduleAI" data-enabled="false" data-selected="false" class="module-card flex items-center justify-between p-3 rounded-lg bg-gray-800/50 border border-gray-700 opacity-30 cursor-not-allowed">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded bg-gray-700 flex items-center justify-center icon-bg transition-colors">
                                <i class="fa-solid fa-brain text-gray-400 icon transition-colors"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-sm text-gray-300 module-title">人工智能检测</h4>
                                <p class="text-xs text-gray-500">MalConv 概率判定</p>
                            </div>
                        </div>
                        <i class="fa-regular fa-circle text-gray-600 status-icon text-lg transition-transform duration-300"></i>
                    </div>

                    <div id="moduleDynamic" data-enabled="false" data-selected="false" class="module-card flex items-center justify-between p-3 rounded-lg bg-gray-800/50 border border-gray-700 opacity-30 cursor-not-allowed">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded bg-gray-700 flex items-center justify-center icon-bg transition-colors">
                                <i class="fa-solid fa-running text-gray-400 icon transition-colors"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-sm text-gray-300 module-title">动态检测</h4>
                                <p class="text-xs text-gray-500">Sigma 日志分析</p>
                            </div>
                        </div>
                        <i class="fa-regular fa-circle text-gray-600 status-icon text-lg transition-transform duration-300"></i>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4">智能分析设置</h3>
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-globe text-cyan-400"></i>
                        <span class="text-sm font-medium">允许 LLM 联网</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="internetToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-500 shadow-inner"></div>
                    </label>
                </div>
                <p class="text-xs text-gray-400 bg-gray-800/50 p-2 rounded">
                    <i class="fa-solid fa-circle-info mr-1"></i> 开启后，报告会提示模型可联网检索威胁情报。请在后端 config/llm_config.json 填写 GLM API 信息。
                </p>
            </div>

            <button id="analyzeBtn" disabled class="w-full py-4 rounded-xl font-bold text-lg bg-gray-700 text-gray-400 cursor-not-allowed transition-all duration-300 flex items-center justify-center gap-2 shadow-lg">
                <i class="fa-solid fa-play"></i> 开始分析
            </button>
        </div>

        <div class="lg:col-span-8 flex flex-col h-full">
            <div class="glass-panel rounded-2xl flex-1 p-0 flex flex-col overflow-hidden relative min-h-[600px]">
                <div class="p-6 border-b border-gray-700 bg-gray-900/40 flex justify-between items-center">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fa-solid fa-file-medical-alt text-purple-400"></i> 分析报告
                    </h2>
                    <div class="flex gap-2">
                        <button id="downloadBtn" class="px-3 py-1.5 rounded-lg bg-gray-700 hover:bg-gray-600 text-sm transition text-gray-300" disabled>
                            <i class="fa-solid fa-download mr-1"></i> 下载报告
                        </button>
                    </div>
                </div>

                <div id="reportEmpty" class="flex-1 flex flex-col items-center justify-center text-gray-500 p-10">
                    <div class="w-20 h-20 rounded-full bg-gray-800 flex items-center justify-center mb-4 animate-pulse">
                        <i class="fa-solid fa-wave-square text-3xl"></i>
                    </div>
                    <p>等待上传样本并开始分析...</p>
                </div>

                <div id="reportLoading" class="hidden absolute inset-0 bg-gray-900/90 z-20 flex flex-col items-center justify-center">
                    <div class="relative w-24 h-24">
                        <div class="absolute inset-0 border-t-4 border-cyan-500 border-solid rounded-full animate-spin"></div>
                        <div class="absolute inset-2 border-t-4 border-purple-500 border-solid rounded-full animate-spin" style="animation-direction: reverse;"></div>
                    </div>
                    <p class="mt-6 text-cyan-400 font-mono text-lg animate-pulse">正在执行多引擎检测...</p>
                    <div class="mt-2 text-sm text-gray-400 space-y-1 text-center" id="loadingSteps"></div>
                </div>

                <div id="reportContent" class="hidden flex-1 overflow-y-auto p-8 bg-gray-900/20 markdown-body text-gray-300 text-sm"></div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = (() => {
            const qs = new URLSearchParams(window.location.search);
            if (qs.get("api")) return qs.get("api");
            const url = new URL(window.location.href);
            if (url.protocol.startsWith("file")) return "http://localhost:8001";
            if (url.port === "8000") return `${url.protocol}//${url.hostname}:8001`;
            return `${url.protocol}//${url.host}`;
        })();

        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const reportEmpty = document.getElementById('reportEmpty');
        const reportLoading = document.getElementById('reportLoading');
        const reportContent = document.getElementById('reportContent');
        const uploadError = document.getElementById('uploadError');

        let currentFileMeta = null;
        let lastReportMarkdown = '';

        const moduleThemes = {
            moduleStatic: { bg: 'bg-cyan-500/20', text: 'text-cyan-400', border: 'border-cyan-500/50' },
            moduleAI: { bg: 'bg-blue-500/20', text: 'text-blue-400', border: 'border-blue-500/50' },
            moduleDynamic: { bg: 'bg-purple-500/20', text: 'text-purple-400', border: 'border-purple-500/50' },
        };

        function applyModuleStyle(el, enabled, selected, theme) {
            el.dataset.enabled = enabled ? 'true' : 'false';
            el.dataset.selected = selected ? 'true' : 'false';
            el.classList.remove('opacity-30', 'opacity-60', 'cursor-not-allowed', 'border-gray-700', 'border-gray-600');
            el.classList.remove(theme.border);
            if (!enabled) {
                el.classList.add('opacity-30', 'cursor-not-allowed', 'border-gray-700');
            } else if (selected) {
                el.classList.add('opacity-100', 'cursor-pointer', theme.border);
            } else {
                el.classList.add('opacity-60', 'cursor-pointer', 'border-gray-600');
            }

            const iconBg = el.querySelector('.icon-bg');
            const icon = el.querySelector('.icon');
            const title = el.querySelector('.module-title');
            const statusIcon = el.querySelector('.status-icon');
            iconBg.className = 'w-8 h-8 rounded bg-gray-700 flex items-center justify-center icon-bg transition-colors';
            icon.className = icon.className.split(' ')[0] + ' ' + icon.className.split(' ')[1] + ' text-gray-400 icon transition-colors';
            title.classList.remove('text-white');

            if (enabled && selected) {
                iconBg.classList.add(theme.bg);
                icon.classList.remove('text-gray-400');
                icon.classList.add(theme.text);
                title.classList.add('text-white');
                statusIcon.className = `fa-solid fa-circle-check ${theme.text} status-icon text-lg`;
            } else if (enabled) {
                statusIcon.className = 'fa-regular fa-circle text-gray-500 status-icon text-lg';
            } else {
                statusIcon.className = 'fa-regular fa-circle text-gray-600 status-icon text-lg';
            }
        }

        function resetModules() {
            Object.keys(moduleThemes).forEach(id => {
                const el = document.getElementById(id);
                applyModuleStyle(el, false, false, moduleThemes[id]);
            });
        }

        function enableModule(id, selected = true) {
            const el = document.getElementById(id);
            applyModuleStyle(el, true, selected, moduleThemes[id]);
        }

        function toggleModule(id) {
            const el = document.getElementById(id);
            if (el.dataset.enabled !== 'true') return;
            const selected = el.dataset.selected === 'true';
            applyModuleStyle(el, true, !selected, moduleThemes[id]);
            updateAnalyzeButton();
        }

        function updateAnalyzeButton() {
            const fileReady = !!currentFileMeta;
            const anySelected = Object.keys(moduleThemes).some(id => document.getElementById(id).dataset.selected === 'true');
            if (fileReady && anySelected) {
                analyzeBtn.disabled = false;
                analyzeBtn.className = 'w-full py-4 rounded-xl font-bold text-lg bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white cursor-pointer transition-all duration-300 shadow-[0_0_20px_rgba(6,182,212,0.4)] hover:scale-[1.02]';
            } else {
                analyzeBtn.disabled = true;
                analyzeBtn.className = 'w-full py-4 rounded-xl font-bold text-lg bg-gray-700 text-gray-400 cursor-not-allowed transition-all duration-300 flex items-center justify-center gap-2 shadow-lg';
            }
        }

        async function uploadFile(file) {
            uploadError.classList.add('hidden');
            const form = new FormData();
            form.append('file', file);
            try {
                const resp = await fetch(`${API_BASE}/api/upload/single`, { method: 'POST', body: form });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.detail || '上传失败');
                currentFileMeta = data.data;
                document.getElementById('fileName').innerText = currentFileMeta.filename;
                document.getElementById('fileSize').innerText = (currentFileMeta.file_size / 1024 / 1024).toFixed(2) + ' MB';
                document.getElementById('fileType').innerText = `类型：${currentFileMeta.file_type}  MD5：${currentFileMeta.md5}`;
                document.getElementById('uploadPlaceholder').classList.add('hidden');
                document.getElementById('fileInfo').classList.remove('hidden');
                resetModules();
                if (currentFileMeta.file_type === 'EVTX') {
                    enableModule('moduleDynamic', true);
                } else {
                    enableModule('moduleStatic', true);
                    enableModule('moduleAI', true);
                }
                updateAnalyzeButton();
            } catch (err) {
                uploadError.innerText = `上传失败：${err}`;
                uploadError.classList.remove('hidden');
            }
        }

        async function startAnalysis() {
            if (!currentFileMeta) return;
            reportEmpty.classList.add('hidden');
            reportContent.classList.add('hidden');
            reportLoading.classList.remove('hidden');
            downloadBtn.disabled = true;
            lastReportMarkdown = '';

            const modules = Object.keys(moduleThemes)
                .filter(id => document.getElementById(id).dataset.selected === 'true')
                .map(id => id === 'moduleStatic' ? 'static' : id === 'moduleAI' ? 'ai' : 'dynamic');
            document.getElementById('loadingSteps').innerHTML = modules.map(m => `<p class="opacity-60">正在执行 ${m.toUpperCase()} 模块...</p>`).join('');

            try {
                const resp = await fetch(`${API_BASE}/api/detection/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: currentFileMeta.file_id,
                        modules,
                        internet: document.getElementById('internetToggle').checked
                    })
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.detail || '分析失败');
                renderResults(data.data);
            } catch (err) {
                reportContent.classList.remove('hidden');
                reportContent.innerHTML = `<p class="text-red-400">分析失败：${err}</p>`;
            } finally {
                reportLoading.classList.add('hidden');
            }
        }

        function renderResults(payload) {
            const { results, llm_report } = payload;
            const modulesMd = results.map(r => {
                const status = r.status === 'success' ? '成功' : (r.status === 'skipped' ? '跳过' : '失败');
                const verdict = r.is_malicious === null ? '-' : (r.is_malicious ? '恶意' : '良性');
                const detailLines = [];
                if (r.message) detailLines.push(`- 描述：${r.message}`);
                if (r.matches && r.matches.length) {
                    detailLines.push(`- 命中规则（${r.matches.length}）：${r.matches.map(m => m.rule_name).join(', ')}`);
                }
                if (r.prediction) {
                    detailLines.push(`- 预测详情：${JSON.stringify(r.prediction)}`);
                }
                return `- **模块：${r.module.toUpperCase()}**\n  - 状态：${status}\n  - 判定：${verdict}${detailLines.length ? '\n  ' + detailLines.join('\n  ') : ''}`;
            }).join('\n');

            const normalizeMarkdown = (text) => {
                if (!text) return '';
                let out = text.trim();
                if (out.startsWith('```')) {
                    out = out.replace(/^```[a-zA-Z]*\n?/, '').replace(/```\s*$/, '');
                }
                return out;
            };

            const llmMarkdown = normalizeMarkdown(llm_report.report);

            const md = `
# 恶意文件检测报告
**样本名称**：${payload.file.filename}  
**文件类型**：${payload.file.file_type}  
**MD5**：${payload.file.md5}  
**检测模块**：${payload.modules.join(', ')}

## 引擎结果
${modulesMd}

## LLM 分析
${llmMarkdown || '（无 LLM 输出）'}
`;
            lastReportMarkdown = md;
            reportContent.innerHTML = window.marked ? marked.parse(md) : md.replace(/\n/g, '<br>');
            reportContent.classList.remove('hidden');
            reportEmpty.classList.add('hidden');
            downloadBtn.disabled = false;
        }

        fileInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) uploadFile(file);
        });

        dropZone.addEventListener('dragover', e => {
            e.preventDefault();
            dropZone.classList.add('border-cyan-500');
        });
        dropZone.addEventListener('dragleave', e => {
            e.preventDefault();
            dropZone.classList.remove('border-cyan-500');
        });
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('border-cyan-500');
            const file = e.dataTransfer.files[0];
            if (file) uploadFile(file);
        });

        document.getElementById('removeBtn').addEventListener('click', () => {
            currentFileMeta = null;
            fileInput.value = '';
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('fileInfo').classList.add('hidden');
            resetModules();
            updateAnalyzeButton();
        });

        Object.keys(moduleThemes).forEach(id => {
            document.getElementById(id).addEventListener('click', () => toggleModule(id));
        });

        analyzeBtn.addEventListener('click', startAnalysis);
        downloadBtn.addEventListener('click', () => {
            if (!lastReportMarkdown) return;
            const blob = new Blob([lastReportMarkdown], { type: 'text/markdown;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentFileMeta?.filename || 'report'}.md`;
            a.click();
            URL.revokeObjectURL(url);
        });

        resetModules();
        updateAnalyzeButton();

        // Matrix Rain
        const canvas = document.getElementById('matrixCanvas');
        const ctx = canvas.getContext('2d');
        let width = canvas.width = window.innerWidth;
        let height = canvas.height = window.innerHeight;
        const chars = '01';
        const charArray = chars.split('');
        const fontSize = 16;
        let columns = width / fontSize;
        const drops = [];
        for (let i = 0; i < columns; i++) { drops[i] = Math.random() * -100; }
        function drawMatrix() {
            ctx.fillStyle = 'rgba(15, 23, 42, 0.1)';
            ctx.fillRect(0, 0, width, height);
            ctx.fillStyle = '#06b6d4';
            ctx.font = fontSize + 'px monospace';
            ctx.shadowBlur = 8;
            ctx.shadowColor = '#06b6d4';
            for (let i = 0; i < drops.length; i++) {
                const text = charArray[Math.floor(Math.random() * charArray.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > height && Math.random() > 0.98) { drops[i] = 0; }
                drops[i]++;
            }
            ctx.shadowBlur = 0;
        }
        setInterval(drawMatrix, 33);
        window.addEventListener('resize', () => {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            const newColumns = Math.ceil(width / fontSize);
            if (newColumns > columns) { for (let i = columns; i < newColumns; i++) { drops[i] = Math.random() * -100; } }
            columns = newColumns;
        });
    </script>
</body>
</html>
